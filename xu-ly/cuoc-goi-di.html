<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cuộc gọi đi</title>
  <style>
    /* Định dạng chung cho giao diện cuộc gọi */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .call-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .caller-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .calling-status {
      font-size: 16px;
      color: gray;
    }
    .end-call-btn {
      padding: 10px 20px;
      background: red;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
      transition: 0.3s;
      margin-top: 20px;
    }
    .end-call-btn:hover {
      background: darkred;
    }
  </style>
</head>
<body>
  <div class="call-header">
    <img src="../uploads/avatars/default.jpg" alt="Profile Picture" class="profile-pic" id="profilePic">
    <div class="caller-name" id="callerName">Đang tải...</div>
    <div class="calling-status" id="callingStatus">Đang gọi...</div>
  </div>
  <button class="end-call-btn" onclick="endCall()">Kết thúc</button>

  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
    // Lấy các tham số từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const fromUserId = urlParams.get('from_id');
    const toFriendId = urlParams.get('to_friend_id');

    console.log('From user:', fromUserId);
    console.log('Calling friend:', toFriendId);
    
    // Kết nối đến Socket.IO server
    const socket = io('http://localhost:3000', {
      reconnection: true,
      timeout: 10000
    });
    
    socket.on('connect', () => {
    console.log('Socket from cuoc-goi-di.html connected:', socket.id);
    socket.emit('register-user', fromUserId);

    // Gửi yêu cầu gọi nếu cần
    if (fromUserId && toFriendId) {
        socket.emit('call-user', {
            fromUserId: fromUserId,
            toUserId: toFriendId
        });

        // Đặt hẹn giờ 15 giây để kiểm tra phản hồi của cuộc gọi
        const callTimeout = setTimeout(() => {
            console.log("Không có phản hồi sau 3 giây, kết thúc cuộc gọi.");
            socket.emit('call-ended', { fromUserId, toUserId: toFriendId });
        }, 3000); // 3 giây

        // Nếu người nhận chấp nhận cuộc gọi, hủy đếm ngược
        socket.on('call-accepted', () => {
            clearTimeout(callTimeout);
            console.log("Cuộc gọi đã được chấp nhận.");
        });

        // Nếu người nhận từ chối cuộc gọi, hủy đếm ngược
        socket.on('call-rejected', () => {
            clearTimeout(callTimeout);
            console.log("Cuộc gọi bị từ chối.");
        });
        }
        });

    //   // Lấy thông tin bạn được gọi (ví dụ qua API)
    //   fetch(`getUserInfo.php?user_id=${toFriendId}`)
    //     .then(response => response.json())
    //     .then(data => {
    //       if (!data.error) {
    //         document.getElementById('callerName').textContent = data.name;
    //         document.getElementById('profilePic').src = data.avatar;
    //       } else {
    //         document.getElementById('callerName').textContent = 'Không tìm thấy thông tin';
    //       }
    //     })
    //     .catch(error => console.error('Error fetching user info:', error));
    
    // Xử lý phản hồi khi cuộc gọi được chấp nhận
    socket.on('call-accepted', (data) => {
      document.getElementById('callingStatus').textContent = 'Đã kết nối';
      console.log('Call accepted, room:', data.roomID);
      // Ở đây bạn có thể khởi tạo kết nối WebRTC nếu cần
    });

    // Xử lý cuộc gọi bị từ chối
    socket.on('call-rejected', (data) => {
      document.getElementById('callerName').textContent = 'Cuộc gọi bị từ chối';
      console.log('Call rejected');
      setTimeout(() => endCall(), 2000);
    });

    // Xử lý cuộc gọi thất bại
    socket.on('call-failed', (data) => {
      document.getElementById('callerName').textContent = 'Cuộc gọi thất bại: ' + data.message;
      console.log('Call failed:', data.message);
      setTimeout(() => endCall(), 2000);
    });

    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      document.getElementById('callerName').textContent = 'Lỗi kết nối';
    });

    // Hàm kết thúc cuộc gọi
    function endCall() {
      if (socket.connected) {
        socket.emit('call-rejected', {
          fromUserId: fromUserId,
          toUserId: toFriendId
        });
      }
    }

    // Xử lý khi trang đóng
    window.onbeforeunload = () => {
      if (socket.connected) {
        socket.emit('call-rejected', {
          fromUserId: fromUserId,
          toUserId: toFriendId
        });
      }
    };
  </script>
</body>
</html>
